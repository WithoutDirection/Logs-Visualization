# Deploy LogViz (Django) on Arch Linux

This guide deploys the Django app using Gunicorn + Nginx + systemd on Arch Linux. It keeps the app running as a service and serves it via Nginx.

Note: The app currently uses SQLite by default. That's fine for small to moderate load. For production at scale, switch to PostgreSQL.

## 1) Create a dedicated user and directories

- Create a user and directories to host the app and a Python virtualenv. Adjust paths as you like; this guide uses `/srv/logviz`.

- Place the repository under `/srv/logviz/Logs-Visualization` (or symlink it there). The Django project root with `manage.py` is `/srv/logviz/Logs-Visualization/LogViz`.

Directory layout used here:

- /srv/logviz
  - venv
  - Logs-Visualization/
    - LogViz/  (contains manage.py)

## 2) System packages

- Install required packages:
  - python (>=3.10)
  - python-virtualenv (or `python-venv` equivalent)
  - nginx

## 3) Python virtual environment and dependencies

- Create a virtualenv and install app requirements:
  - cd /srv/logviz
  - python -m venv venv
  - source venv/bin/activate
  - pip install --upgrade pip wheel
  - pip install -r Logs-Visualization/LogViz/requirements.txt

Note: The `LogViz/requirements.txt` pins `Django<5`. Your `settings.py` was generated by Django 5.x. If you hit import/runtime issues, bump the requirement to `Django>=5.2,<6.0` or align settings to Django 4.2. Choose one path and keep them consistent.

## 4) Environment file

- Copy `deploy/logviz.env.example` to `/etc/logviz.env` and edit values:
  - Set `DJANGO_SECRET_KEY`
  - Set `DJANGO_DEBUG=False`
  - Set `DJANGO_ALLOWED_HOSTS` to your domain/IP
  - Optionally set `DJANGO_CSRF_TRUSTED_ORIGINS` and `DJANGO_CORS_ALLOWED_ORIGINS`

## 5) Initialize the app

- From the Django project directory `/srv/logviz/Logs-Visualization/LogViz`:
  - source /srv/logviz/venv/bin/activate
  - export $(grep -v '^#' /etc/logviz.env | xargs -d '\n' -I{} echo {})  # optional one-off load
  - python manage.py migrate
  - python manage.py collectstatic --noinput
  - python manage.py createsuperuser  # optional

## 6) Systemd service (Gunicorn)

- Edit `deploy/logviz-gunicorn.service` and replace paths/user to match your system. Then copy it to `/etc/systemd/system/logviz-gunicorn.service`.

Example important lines to adjust:

- User=logviz
- Group=logviz
- WorkingDirectory=/srv/logviz/Logs-Visualization/LogViz
- ExecStart=/srv/logviz/venv/bin/gunicorn --access-logfile - --workers 3 --bind 127.0.0.1:8001 LogViz.wsgi:application

Enable and start:

- sudo systemctl daemon-reload
- sudo systemctl enable --now logviz-gunicorn
- sudo systemctl status logviz-gunicorn

## 7) Nginx reverse proxy

- Copy `deploy/nginx_logviz.conf` to `/etc/nginx/conf.d/logviz.conf` and update:
  - server_name to your domain/IP
  - alias paths for `/static/` and `/media/` to match `STATIC_ROOT` and `MEDIA_ROOT`:
    - STATIC_ROOT: `Logs-Visualization/LogViz/staticfiles/`
    - MEDIA_ROOT:  `Logs-Visualization/LogViz/media/`

- Test and reload Nginx:
  - sudo nginx -t
  - sudo systemctl reload nginx

## 8) Firewall (if applicable)

- Allow inbound TCP 80 (and 443 if using TLS via a reverse proxy like Nginx or Caddy).

## 9) TLS (HTTPS)

- Recommended to front Nginx with Certbot or use Caddy for automatic HTTPS. If using Certbot with Nginx:
  - pacman -S certbot certbot-nginx
  - sudo certbot --nginx -d example.com -d www.example.com

## 10) Verify

- Visit http://your-domain/ and ensure:
  - Static files load (CSS/JS)
  - API endpoints respond
  - Admin is reachable at /admin/

## Notes and troubleshooting

- Environment-driven settings:
  - `settings.py` now reads `DJANGO_SECRET_KEY`, `DJANGO_DEBUG`, `DJANGO_ALLOWED_HOSTS`, `DJANGO_CSRF_TRUSTED_ORIGINS`, and `DJANGO_CORS_ALLOWED_ORIGINS` from the environment.

- Static files:
  - `STATIC_ROOT` is `Logs-Visualization/LogViz/staticfiles/`. After `collectstatic`, Nginx serves `/static/` from this path.

- Database:
  - Default SQLite lives at `Logs-Visualization/LogViz/db.sqlite3`.
  - For PostgreSQL, install `postgresql` and set `DATABASE_URL` (and update settings to use `dj-database-url`), then run migrations.

- Upgrades:
  - After code updates: pull changes, re-install dependencies if needed, re-run `collectstatic`, then `sudo systemctl restart logviz-gunicorn`.
